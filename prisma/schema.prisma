// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client"
  output          = "./generated"
  engineType      = "client"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
}

model User {
  address           String             @id @unique
  username          String?            @unique @map("username")
  email             String?            @unique @map("email")
  bio               String?            @map("bio")
  avatarUrl         String?            @map("avatar_url")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  userRefreshTokens UserRefreshToken[]

  @@index(address)
  @@map("users")
}

model UserRefreshToken {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  token       String   @unique
  userAddress String   @map("user_address")
  createdAt   DateTime @default(now())
  expiredAt   DateTime

  user User @relation(fields: [userAddress], references: [address])

  @@index(userAddress)
  @@index(expiredAt)
  @@map("user_refresh_tokens")
}

model CursorEvent {
  type     String
  network  String
  eventSeq String @map("event_seq")
  txDigest String @map("tx_digest")

  @@unique([type, network])
  @@map("cursor_events")
}

model EventLog {
  id                String
  network           String
  packageId         String @map("package_id")
  transactionModule String @map("transaction_module")
  sender            String
  type              String
  parsedJson        Json   @map("parsed_json")
  bcsEncoding       String @map("bcs_encoding")
  bcs               String @map("bcs")
  timestampMs       BigInt @map("timestamp_ms")
  rawData           Json   @map("raw_data")

  @@unique([id, network])
  @@map("event_logs")
}

enum ProjectStatus {
  DRAFT
  OPEN
  COMPLETED
  PUBLISHED
}

model Project {
  id                     String        @id
  network                String
  curator                String
  title                  String
  description            String
  submissionRequirements String[]      @map("submission_requirements")
  dataType               String        @map("data_type")
  category               String        @map("category")
  imageUrl               String        @map("image_url")
  rewardPool             BigInt        @map("reward_pool")
  totalRewardPool        BigInt        @map("total_reward_pool")
  targetSubmissions      BigInt        @map("target_submissions")
  status                 ProjectStatus @map("status")
  submissionsCount       BigInt        @map("submissions_count")
  approvedCount          BigInt        @map("approved_count")
  rejectedCount          BigInt        @map("rejected_count")
  createdAt              BigInt?       @map("created_at")
  deadline               BigInt?       @map("deadline")

  submissions Submission[]
  listing     MarketplaceListing?

  @@unique([id, network])
  @@map("projects")
}

enum MarketplaceStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ListingStatus {
  ACTIVE
  SOLD
  CANCELLED
  EXPIRED
}

model MarketplaceListing {
  id                         String  @id
  network                    String
  projectId                  String  @unique @map("project_id")
  price                      BigInt
  datasetCollectionBlobId    String  @map("dataset_collection_blob_id")
  datasetCollectionPublicKey String  @map("dataset_collection_public_key")
  lastSaleEpochTimestamp     BigInt  @map("last_sale_epoch_timestamp")
  totalSalesAmount           BigInt  @map("total_sales_amount")
  totalSalesCount            BigInt  @map("total_sales_count")
  curator                    String
  createdAt                  BigInt? @map("created_at")
  updatedAt                  BigInt? @map("updated_at")

  sales   ListingSale[]
  project Project?      @relation(fields: [projectId], references: [id])

  @@unique([id, network])
  @@index([projectId, network])
  @@map("marketplace_listings")
}

model ListingSale {
  id         String              @id
  network    String
  listingId  String              @map("listing_id")
  buyer      String
  paidAmount BigInt              @map("paid_amount")
  boughtAt   BigInt              @map("bought_at")
  listing    MarketplaceListing? @relation(fields: [listingId], references: [id])

  @@unique([id, network])
  @@map("listing_sales")
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

model Submission {
  id                   String           @id
  network              String
  projectId            String           @map("project_id")
  contributor          String
  status               SubmissionStatus
  rewardPaid           BigInt           @map("reward_paid")
  fullDatasetPublicKey String           @map("full_dataset_public_key")
  submittedAt          BigInt?          @map("submitted_at")
  reviewedAt           BigInt?          @map("reviewed_at")

  project Project? @relation(fields: [projectId], references: [id])

  @@unique([id, network])
  @@map("submissions")
}

model CryptoKeypair {
  creator    String
  publicKey  String   @map("public_key")
  privateKey String   @map("private_key")
  keyType    String   @map("key_type")
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([creator, publicKey])
  @@map("crypto_keypairs")
}

model AccountAccessCryptoKeypair {
  address   String
  publicKey String @map("public_key")

  @@unique([address, publicKey])
  @@map("account_access_crypto_keypairs")
}

model MediaFile {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  mimeType    String
  extension   String
  filePathKey String   @unique @map("file_path_key")
  publicUrl   String   @map("public_url")
  size        Int?
  uploader    String
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("media_files")
}
